import { readFile } from "node:fs/promises";
import path from "node:path";
import { fileURLToPath, pathToFileURL } from "node:url";
import openapiTS, { astToString } from "openapi-typescript";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const specPath = path.resolve(__dirname, "../api-specs/internal/microgrid.openapi.yaml");
const generatedPath = path.resolve(__dirname, "../shared/src/generated/openapi.ts");

const ast = await openapiTS(pathToFileURL(specPath));
const expected =
  [
  "// Auto-generated by scripts/generate-openapi-types.mjs",
  "// Do not edit manually.",
  astToString(ast)
].join("\n\n") + "\n";

const actual = await readFile(generatedPath, "utf8").catch(() => "");

if (expected !== actual) {
  console.error("[openapi] generated types are stale. Run: pnpm run openapi:generate");
  process.exit(1);
}

console.log("[openapi] generated types are in sync");
