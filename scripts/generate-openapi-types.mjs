import { mkdir, readFile, writeFile } from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";
import yaml from "js-yaml";
import openapiTS, { astToString } from "openapi-typescript";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const specPath = path.resolve(__dirname, "../api-specs/internal/microgrid.openapi.yaml");
const outPath = path.resolve(__dirname, "../shared/src/generated/openapi.ts");

const source = await readFile(specPath, "utf8");

const spec = yaml.load(source);
const ast = await openapiTS(spec);
const content = [
  "// Auto-generated by scripts/generate-openapi-types.mjs",
  "// Do not edit manually.",
  astToString(ast)
].join("\n\n");

await mkdir(path.dirname(outPath), { recursive: true });
await writeFile(outPath, `${content}\n`, "utf8");

console.log(`[openapi] generated ${outPath}`);
